<!DOCTYPE html>
<html lang="en">
<head>
  <title>Edge Browser Service Worker Websocket Error Reproduction</title>
  <style>
    * { box-sizing: border-box; border: 0; margin: 0; padding: 0; }
    html { font-family: sans-serif; font-size: 15px; color: #202020; }
    body { background-color: #f0f0f0; padding: 2em; }
    p, pre { margin-bottom: 0.25em; font-weight: bold; }
  </style>
</head>

<body>
  
<p>
  Open console and configure persistent logs.
  If everything is working, you should see
</p>
<pre>[client] loaded</pre>
<p>in the console log.</p>

<script type="application/javascript">
  
self.addEventListener('load', () => {

  const log = (...args) => console.log('[loader]', ...args)
  const { serviceWorker } = navigator
  const { controller } = serviceWorker

  log('ServiceWorker initialization; exists already?', !!controller)
  serviceWorker.addEventListener('controllerchange', handleControllerChange)
  serviceWorker.addEventListener('message', handleServiceWorkerMessage)
  serviceWorker.startMessages && serviceWorker.startMessages() // Edge does not support `startMessages`
  if (controller) {
    controller.postMessage({ type: 'new-tab' })
  } else {
    serviceWorker.register('/service-worker.js')
      .then(() => log('ServiceWorker registration started'))
      .catch(error => log('ServiceWorker initialization failed:', error))
  }
  
  function handleControllerChange() {
    log('controller change')
    if (controller) {
      log('ServiceWorker updated to a new version')
      alert('New version loaded. Refreshing now!')
      location.reload()
    } else {
      log('new ServiceWorker installed')
      loadClientResources()
    }
  }
  
  function handleServiceWorkerMessage(message) {
    const { data } = message
    log('message from ServiceWorker', data)
    if (data.type === 'proceed') loadClientResources()
  }
  
  function loadClientResources() {
    log('adding client resources')
    const script = document.createElement('script')
    script.async = true
    script.src = '/client.js'
    document.body.appendChild(script)
  }
  
})
  
</script>

</body>

</html>
